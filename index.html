<html>
<head><title>World History Of: Religions</title>
<script type="text/javascript">

var mapData, width = 0, height = 0, religions = [], years = [], sea;
var cellWidth = 16, cellHeight = 8, barHeight = 30, barMargin = 3;
var canvas, year = 0, running = false, activeReligion;

var speed = 500, muted; // ms

function play() {
	if(play.timeout) {
		clearTimeout(play.timeout);
		play.timeout = null;
	}
	var audio = document.getElementById("audio");
	audio.pause();
	if(muted) {
		play.timeout = setTimeout(next,speed);
		return;
	}
	if(!play.audio_events_added) {
		audio.addEventListener("ended",next,false);
		audio.addEventListener("error",function(evt) {
			console.log("onerror",evt);
			play.timeout = setTimeout(next,speed);
		},false);
		play.audio_events_added = true;
	}
	if(audio.canPlayType('audio/mpeg;')) {
		audio.type = "audio/mpeg";
		audio.src = "map_v4_"+years[year]+".mp3";
	} else {
		audio.type = "audio/ogg";
		audio.src = "map_v4_"+years[year]+".ogg";
	}
	audio.play();
}

function next() {
	if(running) {
		if(++year >= years.length) {
			year--;
			running = false;
		} else {
			play();
		}
		draw();
	}
	hideTooltip();
}

function showTooltip(msg,x,y) {
	var tooltip = document.getElementById("tooltip");
	if(msg) {
		var	innerHTML = escape(msg).replace(/%(..)/g,"&#x$1;"),
			xofs = 20,
			yofs = 10;
		innerHTML += "<b style=\""+
			"position: absolute; top: -"+yofs+"px; left: "+(xofs-10)+"px; "+
			"margin: 0; border-top: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; "+
			"border-bottom: 10px solid white; "+
			"padding: 0; width: 0; height: 0; "+
			"\"></b>";
		tooltip.innerHTML = innerHTML;
		tooltip.style.display = "";
		tooltip.style.left = ""+(x-xofs)+"px";
		tooltip.style.top = ""+(y+yofs)+"px";
	} else
		hideTooltip();
}

function hideTooltip() {
	if(activeReligion) {
		activeReligion = null;
		draw();
	}
	tooltip.style.display = "none";
}

function info(evt) {
	evt = evt || window.event;
	evt.cancelBubble = true;
	if(evt.stopPropagation)
		evt.stopPropagation();
	if(!mapData) return;
	evt = evt || window.event;
	var	x = evt.pageX - canvas.offsetLeft,
        	y = evt.pageY - canvas.offsetTop;
	if(y > height*cellHeight) {
		hideTooltip();
		if(evt.type != "mousedown") return;
		var	minX = barMargin*2+barHeight,
			maxX = canvas.width-barMargin*3-barHeight*3;
		if(x < minX) {
			running = !running;
			if(running)
				play();
		} else if(x > minX+maxX) {
			muted = !muted;
			play();
		} else {
			running = false;
			x = Math.min(x-minX,maxX);
			year = Math.min(parseInt(x/(maxX/years.length)),years.length-1);
			play();
		}
		draw();
	} else {
		x = parseInt(x / cellWidth);
		y = parseInt(y / cellHeight);
		var	religion = mapData[year*width*height+((width-x-1)*height)+(height-y-1)],
			prevReligion = activeReligion;
		activeReligion = (religion!=sea)? religion: null;
		showTooltip(activeReligion? religions[activeReligion][1]: null,evt.pageX,evt.pageY);
		if(prevReligion != activeReligion)
			draw();
	}
}

function fillRoundedRect(ctx,x,y,w,h,r) {
	ctx.beginPath();
	ctx.moveTo(x+r, y);
	ctx.arcTo(x+w, y,   x+w, y+h, r);
	ctx.arcTo(x+w, y+h, x,   y+h, r);
	ctx.arcTo(x,   y+h, x,   y,   r);
	ctx.arcTo(x,   y,   x+w, y,   r);
	ctx.fill();
}

function draw() {
	var ctx = canvas.getContext("2d");
	ctx.font = "bold 15px sans-serif";
	ctx.textAlign = "left";
	ctx.textBaseline = "middle";
	ctx.fillStyle = "#ffffff";
	ctx.clearRect(0,0,canvas.width,canvas.height);
	if(!years.length) {
		ctx.clearRect(0,0,canvas.width,canvas.height);
		var	label = "loading, please wait...",
			w = ctx.measureText(label).width;
		ctx.fillStyle = "#ff7070";
		fillRoundedRect(ctx,(canvas.width-w-barMargin)/2,canvas.height / 2,w+barMargin*2,barHeight,barMargin);
		ctx.fillStyle = "#ffffff";
		ctx.fillText(label,(canvas.width-w)/2,(canvas.height / 2)+20);
		return;
	}
	var ofs = year*width*height, y, x, prevCol, prevRow, cell;
	for(var x=width-1; x>-1; x--)
		for(var y=height-1; y>-1; y--) {
			prevRow = cell;
			prevCol = (ofs>=height? mapData[ofs-height]: -1);
			cell = mapData[ofs++];
			ctx.fillStyle = religions[cell][2];
			ctx.fillRect(x*cellWidth,y*cellHeight,cellWidth-0.25,cellHeight-0.25);
			if(cell != prevCol) {
				ctx.strokeStyle = (prevCol==activeReligion || cell==activeReligion)? "#ff2020": "#a0a0a0";
				ctx.beginPath();
				ctx.moveTo((x+1)*cellWidth-1,y*cellHeight);
				ctx.lineTo((x+1)*cellWidth-1,y*cellHeight+cellHeight);
				ctx.stroke();
			}
			if(cell != prevRow) {
				ctx.strokeStyle = (prevRow==activeReligion || cell==activeReligion)? "#ff2020": "#a0a0a0";
				ctx.beginPath();
				ctx.moveTo(x*cellWidth-1,(y+1)*cellHeight);
				ctx.lineTo(x*cellWidth+cellWidth,(y+1)*cellHeight);
				ctx.stroke();
			}
		}
	// year label
	var label = years[year];
	if(label < 0)
		label = ""+Math.abs(label)+" BC";
	else
		label = ""+label+" AD";
	var textWidth = ctx.measureText(label).width;
	ctx.fillStyle = "#ffffff";
	fillRoundedRect(ctx,25,height*cellHeight-50,textWidth+10,20,5);
	ctx.fillStyle = "#000000";
	ctx.fillText(label,30,height*cellHeight-40);
	// clip to tidy up arc abuse in opera
	ctx.save();
	ctx.beginPath();
	ctx.moveTo(0,height*cellHeight-1);
	ctx.lineTo(canvas.width,height*cellHeight-1);
	ctx.lineTo(canvas.width,canvas.height);
	ctx.lineTo(0,canvas.height);
	ctx.clip();
	ctx.clearRect(0,0,canvas.width,canvas.height);
	// year bar
	ctx.fillStyle = "#ffffff";
	ctx.fillRect(0,height*cellHeight/2,canvas.width,barHeight);
	ctx.fillStyle = "#707070";
	fillRoundedRect(ctx,barMargin*2+barHeight,height*cellHeight+barMargin,
		canvas.width-barMargin*3-barHeight*3,
		barHeight-barMargin*2,(barHeight*2-barMargin*4)/2);
	ctx.fillStyle = "#ff7070";
	fillRoundedRect(ctx,barMargin*2+barHeight,height*cellHeight+barMargin,
		barMargin*2+barHeight+(canvas.width-barMargin-barHeight*4)*(year/years.length),
		barHeight-barMargin*2,(barHeight*2-barMargin*4)/2);
	// play stop button
	ctx.fillStyle = "#707070";
	fillRoundedRect(ctx,barMargin,height*cellHeight+barMargin,barHeight-barMargin,barHeight-barMargin*2,(barHeight-barMargin*2)/2);
	ctx.fillStyle = "#ffffff";
	ctx.fillText(running?"||":">",barHeight/3,canvas.height-barHeight/2);
	// mute button
	ctx.fillStyle = "#707070";
	fillRoundedRect(ctx,canvas.width-barHeight*2+barMargin*2,height*cellHeight+barMargin,barHeight*2-barMargin*2,barHeight-barMargin*2,(barHeight-barMargin*2)/2);
	ctx.fillStyle = muted? "#ff7070":"#ffffff";
	ctx.fillText(muted?"audio":"mute",canvas.width-barHeight*2+barMargin*3,canvas.height-barHeight/2);
	// unclip
	ctx.restore();
}

function setData(data) {
	var	rows = data.split("\n"),
		row, i, j, x, y,
		LOWER = 33,
		UPPER = 122,
		RANGE = UPPER-LOWER,
		MIN = 1,
		numReligions = parseInt(rows[0]);
	// get the religions
	for(i=0; i<numReligions; i++) {
		row = rows[1+i].split("\t");
		if(row[0] == "Sea")
			sea = i;
		religions.push([i,row[0],row[1]]);
	}
	// get the years
	years = rows[1+numReligions].split("\t");
	// various markers
	row = rows[2+numReligions].split("\t");
	width = parseInt(row[0]);
	height = parseInt(row[1]);
	var	code = numReligions,
		dup = code++,
		run_short = code++,
		run_long = code++,
		ch, flag, run, buf,
		ofs = 0, chksum = 0;
	// decompress the data
	buf = rows[3+numReligions];
	console.log("compressed is",buf.length);
	for(i=4+numReligions; i<rows.length; i++) {
		row = rows[i].trim();
		if(!row.length) break;
		row = row.split("\t");
		//console.log(i-4-numReligions+1,"replace",row[0],"with",row[1],buf.length);
		buf = buf.split(row[0]).join(row[1]);
	}
	console.log("uncompressed is",buf.length);
	// un-RLE it
	mapData = new Uint8Array(width*height*years.length);
	for(i=0; i<buf.length; i++) {
		ch = buf.charCodeAt(i)-LOWER;
		if(ch < 0 || ch >= code)
			console.log("ERROR",i,ch,buf.charCodeAt(i),LOWER,code);
		flag = buf.charCodeAt(i+1)-LOWER;
		run = 1;
		if(flag == run_short) {
			run += buf.charCodeAt(i+2)-LOWER;
			run += MIN;
			i += 2;
		} else if(flag == run_long) {
			run += (buf.charCodeAt(i+2)-LOWER)*RANGE;
			run += buf.charCodeAt(i+3)-LOWER;
			run += MIN;
			i += 3;
		}
		for(j=0; j<run; j++) {
			mapData[ofs++] = ch;
			chksum += ch;
		}
	}
	console.log(mapData.length,ofs-1,chksum);
	// de-dup it
	var	prev = new Uint8Array(width*height),
		religion, ofs = 0;
	for(i=0; i<years.length; i++)
		for(j=0; j<width*height; j++,ofs++) {
			religion = mapData[ofs];
			if(religion == dup)
				mapData[ofs] = prev[j];
			else
				prev[j] = religion;
		}
	// draw it
	canvas.width = width*cellWidth;
	canvas.height = height*cellHeight + barHeight;
	draw();
}

function init() {
	canvas = document.getElementById("canvas");
	draw();
	canvas.addEventListener('mousedown',info,false);
	canvas.addEventListener('mousemove',info,false);
	// load the colours
	var doc = new XMLHttpRequest();
	doc.open("GET","map_v4_data.txt",true);
	doc.overrideMimeType('text/plain; charset=x-user-defined');
	doc.onreadystatechange = function() {
		if (doc.readyState==4 && (!doc.status || doc.status==200))
			setData(doc.response);
	};
	doc.send();
}

// fun stats

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-27302158-1']);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

</script>
<body style="font-family:sans-serif;" onload="init()">
<div id="tooltip" style="position:absolute; display:none; background-color:white; color:blue;
	margin: 3px 0; padding: 3px 5px; 
	-moz-border-radius: 6px; -webkit-border-radius: 6px; border-radius: 6px;
	border-color: blue; border-width: thin; border-style: solid;
	"></div>
<noscript>
Sorry, you need to enable Javascript to see this interactive map :(<br/>
</noscript>
<canvas id="canvas">
Sorry, you don't have a canvas to visualise on :(<br/>
</canvas>
<audio id="audio">Sorry, your browser doesn't seem to support audio :(</audio>
<p>All the data is available as <a href="https://github.com/williame/map_of_worlds_religions">an animated spreadsheet</a>.
You can also <a href="https://www.youtube.com/watch?v=mEIxdquRnJc">watch this on youtube</a>.<br/>
There is a fun write-up about the technical challenges of publishing this map on <a href="http://williamedwardscoder.tumblr.com/post/37291851878/making-the-history-of-worlds-religions-map">williamedwardscoder.tumblr.com</a>.</p>
</body>
</html>
