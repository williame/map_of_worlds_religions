<html>
<head><title>World History Of: Religions</title>
<script type="text/javascript">

var mapData, width = 0, height = 0, religions = {}, years = [];
var cellWidth = 16, cellHeight = 8, barHeight = 30, barMargin = 3;
var canvas, year = 0, running = false, activeReligion = null;

function play() {
	if(play.timeout) {
		clearTimeout(play.timeout);
		play.timeout = null;
	}
	var audio = document.getElementById("audio");
	audio.pause();
	if(!play.audio_events_added) {
		audio.addEventListener("ended",next,false);
		audio.addEventListener("error",function(evt) {
			console.log("onerror",evt);
			play.timeout = setTimeout(next,1000);
		},false);
		play.audio_events_added = true;
	}
	
	audio.src = "map_v4_"+years[year]+(audio.canPlayType('audio/mpeg;')?".mp3":".ogg");
	audio.play();
}

function next() {
	if(running) {
		if(++year >= years.length) {
			year--;
			running = false;
		} else {
			play();
		}
		draw();
	}
	hideTooltip();
}

function showTooltip(msg,x,y) {
	var tooltip = document.getElementById("tooltip");
	if(msg) {
		var	innerHTML = escape(msg).replace(/%(..)/g,"&#x$1;"),
			xofs = 20,
			yofs = 10;
		innerHTML += "<b style=\""+
			"position: absolute; top: -"+yofs+"px; left: "+(xofs-10)+"px; "+
			"margin: 0; border-top: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; "+
			"border-bottom: 10px solid white; "+
			"padding: 0; width: 0; height: 0; "+
			"\"></b>";
		tooltip.innerHTML = innerHTML;
		tooltip.style.display = "";
		tooltip.style.left = ""+(x-xofs)+"px";
		tooltip.style.top = ""+(y+yofs)+"px";
	} else
		hideTooltip();
}

function hideTooltip() {
	if(activeReligion) {
		activeReligion = null;
		draw();
	}
	tooltip.style.display = "none";
}

function info(evt) {
	evt = evt || window.event;
	evt.cancelBubble = true;
	if(evt.stopPropagation)
		evt.stopPropagation();
	if(!mapData) return;
	evt = evt || window.event;
	var	x = evt.pageX - canvas.offsetLeft,
        	y = evt.pageY - canvas.offsetTop;
	if(y > height*cellHeight) {
		hideTooltip();
		if(evt.type != "mousedown") return;
		var	minX = barMargin*2+barHeight,
			maxX = canvas.width-barMargin*3-barHeight;
		if(x < minX) {
			running = !running;
			if(running)
				play();
		} else {
			running = false;
			x -= minX;
			x = Math.min(x,maxX);
			year = Math.min(parseInt(x/(maxX/years.length)),years.length-1);
			play();
		}
		draw();
	} else {
		x = parseInt(x / cellWidth);
		y = parseInt(y / cellHeight);
		var	religion = mapData[year][y][x],
			prevReligion = activeReligion;
		activeReligion = (religion!="Sea")? religion: null;
		showTooltip(religion,evt.pageX,evt.pageY);
		if(prevReligion != activeReligion)
			draw();
	}
}

function fillRoundedRect(ctx,x,y,w,h,r,outline) {
	ctx.beginPath();
	ctx.moveTo(x+r, y);
	ctx.arcTo(x+w, y,   x+w, y+h, r);
	ctx.arcTo(x+w, y+h, x,   y+h, r);
	ctx.arcTo(x,   y+h, x,   y,   r);
	ctx.arcTo(x,   y,   x+w, y,   r);
	ctx.fill();
}

function draw() {
	var ctx = canvas.getContext("2d");
	ctx.font = "bold 15px sans-serif";
	ctx.fillStyle = "#ffffff";
	ctx.clearRect(0,0,canvas.width,canvas.height);
	if(!years.length) {
		ctx.clearRect(0,0,canvas.width,canvas.height);
		var	label = "loading, please wait...",
			w = ctx.measureText(label).width;
		ctx.fillStyle = "#ff7070";
		fillRoundedRect(ctx,(canvas.width-w-barMargin)/2,canvas.height / 2,w+barMargin*2,barHeight,barMargin);
		ctx.fillStyle = "#ffffff";
		ctx.fillText(label,(canvas.width-w)/2,(canvas.height / 2)+20);
		return;
	}
	var	data = mapData[year],
		prevRow = [];
	for(var y=0; y<height; y++) {
		var	row = data[y],
			prevCol = "";
		for(var x=0; x<width; x++) {
			var cell = row[x];
			ctx.fillStyle = religions[cell].colour;
			ctx.fillRect(x*cellWidth,y*cellHeight,cellWidth-0.25,cellHeight-0.25);
			if(cell != prevCol) {
				ctx.strokeStyle = (prevCol==activeReligion || cell==activeReligion)? "#ff2020": "#a0a0a0";
				ctx.beginPath();
				ctx.moveTo(x*cellWidth-1,y*cellHeight);
				ctx.lineTo(x*cellWidth-1,y*cellHeight+cellHeight);
				ctx.stroke();
			}
			if(cell != prevRow[x]) {
				ctx.strokeStyle = (prevRow[x]==activeReligion || cell==activeReligion)? "#ff2020": "#a0a0a0";
				ctx.beginPath();
				ctx.moveTo(x*cellWidth-1,y*cellHeight);
				ctx.lineTo(x*cellWidth+cellWidth,y*cellHeight);
				ctx.stroke();
			}
			prevCol = cell;
		}
		prevRow = row;
	}
	// year bar
	ctx.fillStyle = "#ffffff";
	ctx.fillRect(0,height*cellHeight,canvas.width,barHeight);
	ctx.fillStyle = "#707070";
	fillRoundedRect(ctx,barMargin*2+barHeight,height*cellHeight+barMargin,
		canvas.width-barMargin*3-barHeight,
		barHeight-barMargin*2,(barHeight-barMargin*2)/2);
	ctx.fillStyle = "#ff7070";
	fillRoundedRect(ctx,barMargin*2+barHeight,height*cellHeight+barMargin,
		barMargin*2+barHeight+(canvas.width-barMargin-barHeight*2)*(year/years.length),
		barHeight-barMargin*2,(barHeight-barMargin*2)/2);
	// play stop button
	ctx.fillStyle = "#707070";
	fillRoundedRect(ctx,barMargin,height*cellHeight+barMargin,barHeight-barMargin,barHeight-barMargin*2,(barHeight-barMargin*2)/2);
	ctx.fillStyle = "#ffffff";
	ctx.fillText(running?"||":">",barHeight/3,canvas.height-barHeight/3);	
	// year label
	var label = years[year];
	if(label < 0)
		label = ""+Math.abs(label)+" BC";
	else
		label = ""+label+" AD";
	var textWidth = ctx.measureText(label).width;
	ctx.fillStyle = "#ffffff";
	ctx.fillRect(25,height*cellHeight-50,textWidth+10,25);
	ctx.fillStyle = "#000000";
	ctx.fillText(label,30,height*cellHeight-30);
}

function makeColour(str) {
    var hash = 0;
    for(var i = 0; i < str.length; i++) {
        var ch = str.charCodeAt(i);
        hash = ((hash<<5)-hash)+ch;
        hash = hash & hash;
    }
    hash = hash & 0xffffff;
    str = hash.toString(16);
    while(str.length < 6)
    	    str = "0"+str;
    return "#"+str;
}

function setData(data) {
	var	rows = data.split("\n"),
		row = rows[1].split("\t");
	// get the years
	for(var year=4; year<row.length-1; year++)
		years.push(parseInt(row[year]));
	// get the data into a hash table
	data = {}; // reuse variable
	for(var row=2; row<rows.length-1 && rows[row].length; row++) {
		var cols = rows[row].split("\t");
		width = Math.max(width,parseInt(cols[0]));
		height = Math.max(height,parseInt(cols[1]));
		var key = cols[3];
		for(var year in years) {
			var col = cols[4+parseInt(year)];
			if(!religions[col]) {
				console.log("didn't find religion",col);
				religions[col] = {
					key: col,
					colour: makeColour(col),
				};
			}
			data[key+"_"+year] = religions[col].key; // interning
		}
	}
	// build the data as a 2D-array per year
	mapData = [];
	for(var year in years) {
		mapData[year] = [];
		for(var y=0; y<height; y++) {
			var row = [];
			for(var x=0; x<width; x++)
				row.push(data[""+(x+1)+"_"+(y+1)+"_"+year] || "None");
			mapData[year].push(row);
		}
	}
	// draw it
	canvas.width = width*cellWidth;
	canvas.height = height*cellHeight + barHeight;
	draw();
}

function setReligions(data) {
	var rows = data.split("\n");
	for(var row in rows) {
		var row = rows[row];
		if(!row.trim()) break;
		var 	cols = row.split("\t"),
			religion = cols[0].trim(),
			colour = cols[1].trim();
		religions[religion] = {
			key: religion,
			colour: colour,
		};
	}
	// load the map data
	var doc = new XMLHttpRequest();
	doc.open("GET","map_v4.tsv",true);
	doc.overrideMimeType('text/plain; charset=x-user-defined');
	doc.onreadystatechange = function() {
		if (doc.readyState==4 && (!doc.status || doc.status==200))
			setData(doc.response);
	};
	doc.send();
}

function init() {
	canvas = document.getElementById("canvas");
	draw();
	canvas.addEventListener('mousedown',info,false);
	canvas.addEventListener('mousemove',info,false);
	// load the colours
	var doc = new XMLHttpRequest();
	doc.open("GET","map_v4_religions.tsv",true);
	doc.overrideMimeType('text/plain; charset=x-user-defined');
	doc.onreadystatechange = function() {
		if (doc.readyState==4 && (!doc.status || doc.status==200))
			setReligions(doc.response);
	};
	doc.send();
}

</script>
<body style="font-family:sans-serif;" onload="init()">
<div id="tooltip" style="position:absolute; display:none; background-color:white; color:blue;
	margin: 3px 0; padding: 3px 5px; 
	-moz-border-radius: 6px; -webkit-border-radius: 6px; border-radius: 6px;
	border-color: blue; border-width: thin; border-style: solid;
	"></div>
<noscript>
Sorry, you need to enable Javascript to see this interactive map :(<br/>
</noscript>
<canvas id="canvas">
Sorry, you don't have a canvas to visualise on :(<br/>
</canvas>
<audio id="audio" type="audio/ogg">Sorry, your browser doesn't seem to support audio :(</audio>
</body>
</html>
